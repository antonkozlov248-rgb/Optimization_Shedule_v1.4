<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Schedule Optimizer Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #32a878;
            --primary-dark: #2a8f68;
            --secondary: #f39c12;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --border: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2D8B7F;
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light);
            background: #f8f9fa;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            color: var(--dark);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background: rgba(50, 168, 120, 0.05);
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: rgba(50, 168, 120, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary-dark);
            background: rgba(50, 168, 120, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--danger);
            background: rgba(231, 76, 60, 0.05);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(50, 168, 120, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #219150;
        }

        .message {
            padding: 15px 20px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid var(--info);
        }

        .message.success {
            background: rgba(39, 174, 96, 0.1);
            border-left-color: var(--success);
            color: var(--success);
        }

        .message.error {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: var(--danger);
            color: var(--danger);
        }

        .message.info {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: var(--info);
            color: var(--info);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin: 10px 0;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
            table-layout: fixed;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #eee;
            vertical-align: top;
            height: 80px;
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
            height: auto;
        }

        tr:hover {
            background: rgba(50, 168, 120, 0.05);
        }

        /* --- DRAG AND DROP & CONFLICT STYLES --- */
        .lesson-card {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: grab;
            transition: all 0.2s ease;
            height: 100%;
            user-select: none;
            position: relative;
        }

        .lesson-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
            border-color: var(--primary);
        }

        .lesson-card:active {
            cursor: grabbing;
        }

        .lesson-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            background: #e8f5e9;
        }

        .lesson-cell.drag-over {
            background: rgba(50, 168, 120, 0.2) !important;
            border: 2px dashed var(--primary);
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–û–ù–§–õ–ò–ö–¢–û–í --- */
        .conflict-teacher {
            border: 2px solid var(--danger) !important;
            background-color: #ffebee !important;
            animation: pulse-red 2s infinite;
        }

        .conflict-room {
            border: 2px solid var(--warning) !important;
            background-color: #fff3e0 !important;
        }

        /* –í–ï–†–ù–£–õ –¢–ï–ú–ù–´–ô –¢–£–õ–¢–ò–ü, –í–ò–î–ò–ú–´–ô –í–°–ï–ì–î–ê –ü–†–ò –ö–û–ù–§–õ–ò–ö–¢–ï */
        .conflict-tooltip {
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-top: 5px;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª–∞—Å—Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞, –õ–ò–ë–û –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .conflict-teacher .conflict-tooltip,
        .conflict-room .conflict-tooltip {
            display: block !important;
            background: #c0392b; /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π */
        }

        .conflict-room .conflict-tooltip {
            background: #e67e22; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π —Ñ–æ–Ω –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–æ–≤ */
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        input[type="file"], select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1em;
        }

        .hidden {
            display: none;
        }

        h2 { margin-bottom: 15px; }
        h3 { margin: 20px 0 10px 0; }
        h4 { margin: 15px 0 5px 0; color: var(--primary); }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5em; }
            .content { padding: 15px; }
            .tab-button { min-width: 100px; padding: 12px 10px; font-size: 0.85em; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Schedule Optimizer Pro v5.1</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è + –£–º–Ω—ã–π Drag-and-Drop —Ä–µ–¥–∞–∫—Ç–æ—Ä</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab(event, 'upload')">üì• –ó–∞–≥—Ä—É–∑–∫–∞</button>
            <button class="tab-button" onclick="switchTab(event, 'generation')">‚ö° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</button>
            <button class="tab-button" onclick="switchTab(event, 'editor')">üîß –†–µ–¥–∞–∫—Ç–æ—Ä</button>
            <button class="tab-button" onclick="switchTab(event, 'export')">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="tab-button" onclick="switchTab(event, 'analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        </div>

        <div class="content">
            <!-- –í–ö–õ–ê–î–ö–ê –ó–ê–ì–†–£–ó–ö–ê -->
            <div id="upload" class="tab-content active">
                <h2>üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–∞—Ä–∞–ª–ª–µ–ª—è—Ö, –ø—Ä–µ–¥–º–µ—Ç–∞—Ö, —É—á–∏—Ç–µ–ª—è—Ö –∏ –∫–∞–±–∏–Ω–µ—Ç–∞—Ö</p>

                <div class="upload-area" id="uploadArea">
                    <p style="font-size: 2em; margin-bottom: 10px;">üìÅ</p>
                    <p><strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</strong></p>
                    <p style="opacity: 0.7; font-size: 0.9em;">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                </div>

                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                </button>

                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel
                </button>

                <div id="uploadMessage"></div>
                <div id="loadedDataInfo"></div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê –ì–ï–ù–ï–†–ê–¶–ò–Ø -->
            <div id="generation" class="tab-content">
                <h2>‚ö° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>

                <button class="btn btn-primary" onclick="startOptimization()" style="font-size: 1.1em; padding: 15px 30px;">
                    üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
                </button>

                <div id="optimizationCard" class="hidden">
                    <h3>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</h3>
                    <p>–ü–æ–∫–æ–ª–µ–Ω–∏–µ: <strong id="generationCounter">0</strong> / 150</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="optimizationStatus" style="font-size: 0.8em; color: gray; margin-top: 5px;">–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –ª—É—á—à–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞...</p>
                </div>

                <div id="resultsCard" class="hidden">
                    <h3>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <p>–ö–∞—á–µ—Å—Ç–≤–æ</p>
                            <h3 id="fitnessScore">75%</h3>
                        </div>
                        <div class="stat-card">
                            <p>–í—Å–µ–≥–æ —É—Ä–æ–∫–æ–≤</p>
                            <h3 id="totalLessons">0</h3>
                        </div>
                        <div class="stat-card">
                            <p>–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã</p>
                            <h3 id="conflictCount">0</h3>
                        </div>
                        <div class="stat-card">
                            <p>SanPin –Ω–∞—Ä—É—à–µ–Ω–∏—è</p>
                            <h3 id="sanpinCount">0</h3>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="switchTab(null, 'editor')">
                        üîß –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    </button>
                </div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê –†–ï–î–ê–ö–¢–û–† -->
            <div id="editor" class="tab-content">
                <h2>üîß –£–º–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä</h2>
                <p style="color: #666; margin-bottom: 15px;">
                    üí° –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —É—Ä–æ–∫–∏. –°–∏—Å—Ç–µ–º–∞ <strong style="color: #e74c3c">–ø–æ–¥—Å–≤–µ—Ç–∏—Ç –∫—Ä–∞—Å–Ω—ã–º</strong> –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É—á–∏—Ç–µ–ª–µ–π –∏ <strong style="color: #f39c12">–æ—Ä–∞–Ω–∂–µ–≤—ã–º</strong> –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∫–∞–±–∏–Ω–µ—Ç–æ–≤.
                </p>

                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <select id="classSelect" onchange="displaySchedule()" style="padding: 10px; width: 300px;">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>
                    </select>

                    <button class="btn btn-success" onclick="saveEditorChanges()" style="background: #27ae60; color: white;">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    <div id="saveStatus"></div>
                </div>

                <div id="scheduleTable"></div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê –≠–ö–°–ü–û–†–¢ -->
            <div id="export" class="tab-content">
                <h2>üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>

                <button class="btn btn-primary" onclick="exportExcel()">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å XLSX
                </button>

                <button class="btn btn-secondary" onclick="exportPDF()">
                    üìÑ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PDF
                </button>

                <button class="btn btn-danger" onclick="exportJSON()">
                    üìã –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON
                </button>

                <button class="btn btn-info" onclick="copyToClipboard()">
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON
                </button>

                <div id="exportMessage"></div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
            <div id="analytics" class="tab-content">
                <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
                <p style="color:#666; margin-bottom: 15px;">
                    –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞: –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, "–æ–∫–Ω–∞" –∏ –∑–∞–≥—Ä—É–∑–∫—É –∫–∞–±–∏–Ω–µ—Ç–æ–≤.
                </p>

                <!-- –°–≤–æ–¥–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
                <div class="stats" style="margin-top:10px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        <p>–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É—á–∏—Ç–µ–ª–µ–π</p>
                        <h3 id="statTeacherConflicts">0</h3>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);">
                        <p>–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∫–∞–±–∏–Ω–µ—Ç–æ–≤</p>
                        <h3 id="statRoomConflicts">0</h3>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <p>"–û–∫–Ω–∞" —É —É—á–∏—Ç–µ–ª–µ–π</p>
                        <h3 id="statTeacherWindows">0</h3>
                    </div>
                    <div class="stat-card">
                        <p>–ò—Ç–æ–≥–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ</p>
                        <h3 id="statFitness">0%</h3>
                    </div>
                </div>

                <h3 style="margin-top:25px;">üìâ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>

                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <button class="btn btn-primary" onclick="updateAnalytics()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>

                <div id="analyticsMessage"></div>

                <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:15px;">
                    <!-- –ì—Ä–∞—Ñ–∏–∫ 1: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ -->
                    <div style="flex:1; min-width:300px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4 style="text-align: center;">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (%)</h4>
                        <div style="height: 300px;">
                            <canvas id="roomLoadChart"></canvas>
                        </div>
                        <p style="font-size: 0.8em; color: #666; text-align: center; margin-top: 5px;">–¢–æ–ø —Å–∞–º—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π</p>
                    </div>

                    <!-- –ì—Ä–∞—Ñ–∏–∫ 2: –ù–∞—Ä—É—à–µ–Ω–∏—è –ø–æ –¥–Ω—è–º -->
                    <div style="flex:1; min-width:300px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4 style="text-align: center;">–°—Ç–∞—Ç—É—Å —É—á–∏—Ç–µ–ª–µ–π (–ù–∞–≥—Ä—É–∑–∫–∞)</h4>
                        <div style="height: 300px; position: relative;">
                            <canvas id="teacherDistributionChart"></canvas>
                        </div>
                        <p style="font-size: 0.8em; color: #666; text-align: center; margin-top: 5px;">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–µ–¥–∞–≥–æ–≥–æ–≤</p>
                    </div>
                </div>

                <div style="margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                     <h4 style="margin-bottom: 10px;">üìã –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–æ–Ω—ã (–¢–æ–ø-5 —É—á–∏—Ç–µ–ª–µ–π —Å –æ–∫–Ω–∞–º–∏)</h4>
                     <ul id="teachersWindowsList" style="list-style: none; padding: 0;">
                         <li style="padding: 8px; border-bottom: 1px solid #eee; color: #7f8c8d;">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç...</li>
                     </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const appState = {
            uploadedData: null,
            schedule: null,
            optimizationResults: null
        };

        let roomLoadChart = null;
        let teacherDistributionChart = null;

        //DRAG-DROP STATE 
        let dragState = {
            sourceDay: null,
            sourceIndex: null,
            sourceLesson: null
        };

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            if (event) event.target.classList.add('active');
            else document.querySelector(`button[onclick*="'${tabName}'"]`).classList.add('active');
        }

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const classes = XLSX.utils.sheet_to_json(workbook.Sheets['–ü–∞—Ä–∞–ª–ª–µ–ª–∏'] || {});
                    const subjects = XLSX.utils.sheet_to_json(workbook.Sheets['–ü—Ä–µ–¥–º–µ—Ç—ã'] || {});
                    const teachers = XLSX.utils.sheet_to_json(workbook.Sheets['–£—á–∏—Ç–µ–ª—è'] || {});
                    const rooms = XLSX.utils.sheet_to_json(workbook.Sheets['–ö–∞–±–∏–Ω–µ—Ç—ã'] || {});

                    appState.uploadedData = { classes, subjects, teachers, rooms };

                    document.getElementById('uploadMessage').innerHTML =
                        '<div class="message success">‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!</div>';

                    document.getElementById('loadedDataInfo').innerHTML = `
                        <div class="message info">
                            üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ:
                            <ul style="margin: 10px 0 0 20px;">
                                <li>${classes.length} –∫–ª–∞—Å—Å(–æ–≤)</li>
                                <li>${subjects.length} –ø—Ä–µ–¥–º–µ—Ç(–æ–≤)</li>
                                <li>${teachers.length} —É—á–∏—Ç–µ–ª—è(–µ–π)</li>
                                <li>${rooms.length} –∫–∞–±–∏–Ω–µ—Ç–∞(–æ–≤)</li>
                            </ul>
                        </div>
                    `;

                    const classSelect = document.getElementById('classSelect');
                    classSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.–∫–ª–∞—Å—Å;
                        option.textContent = cls.–∫–ª–∞—Å—Å;
                        classSelect.appendChild(option);
                    });

                } catch (error) {
                    document.getElementById('uploadMessage').innerHTML =
                        '<div class="message error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function startOptimization() {
            if (!appState.uploadedData) {
                document.getElementById('uploadMessage').innerHTML =
                    '<div class="message error">‚ùå –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–Ω–∞—á–∞–ª–∞</div>';
                return;
            }

            document.getElementById('optimizationCard').classList.remove('hidden');
            document.getElementById('resultsCard').classList.add('hidden');

            const requestData = {
                classes: appState.uploadedData.classes,
                subjects: appState.uploadedData.subjects,
                teachers: appState.uploadedData.teachers,
                rooms: appState.uploadedData.rooms,
                generations: 500, // –í–µ—Ä–Ω—É–ª–∏ 500 –ø–æ–∫–æ–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏
                population_size: 40,
                mutation_rate: 0.2
            };

            let generation = 0;
            const maxGenerations = 150;
            const interval = setInterval(() => {
                generation+=5;
                if(generation > maxGenerations) generation = maxGenerations;
                document.getElementById('generationCounter').textContent = generation;
                document.getElementById('progressBar').style.width = (generation / maxGenerations * 100) + '%';
            }, 900);

            fetch('http://localhost:5000/api/optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(interval);
                document.getElementById('generationCounter').textContent = '500';
                document.getElementById('progressBar').style.width = '100%';

                if (data.success) {
                    appState.schedule = data.schedule;
                    appState.optimizationResults = {
                        fitness: data.fitness,
                        conflicts: data.conflicts || {}
                    };

                    document.getElementById('fitnessScore').textContent = Math.floor(data.fitness) + '%';
                    document.getElementById('totalLessons').textContent = data.total_lessons;

                    const totalConflicts = (data.conflicts.teacher_conflicts || 0) +
                                          (data.conflicts.class_conflicts || 0) +
                                          (data.conflicts.room_conflicts || 0);
                    document.getElementById('conflictCount').textContent = totalConflicts;
                    document.getElementById('sanpinCount').textContent = data.conflicts.sanpin_violations || 0;

                    const classSelect = document.getElementById('classSelect');
                    classSelect.innerHTML = '<option value="">-- –í—ã–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å --</option>';
                    Object.keys(appState.schedule).forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });

                    document.getElementById('optimizationCard').classList.add('hidden');
                    document.getElementById('resultsCard').classList.remove('hidden');

                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    document.getElementById('optimizationCard').classList.add('hidden');
                }
            })
            .catch(error => {
                clearInterval(interval);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
                document.getElementById('optimizationCard').classList.add('hidden');
            });
        }
        
        //–°–û–•–†–ê–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô –ù–ê –°–ï–†–í–ï–†
        
        function saveEditorChanges() {
            if (!appState.schedule) {
                alert("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ!");
                return;
            }

            const status = document.getElementById('saveStatus');
            status.innerHTML = '<span style="color: blue">‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>';

            fetch('http://localhost:5000/api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedule: appState.schedule })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.innerHTML = '<span style="color: green">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>';
                    setTimeout(() => status.innerHTML = '', 3000);
                } else {
                    status.innerHTML = '<span style="color: red">‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</span>';
                }
            })
            .catch(error => {
                status.innerHTML = '<span style="color: red">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</span>';
            });
        }

        // DRAG AND DROP & –ü–†–û–í–ï–†–ö–ê –ù–ê –ö–û–ù–§–õ–ò–ö–¢–´

        function renumberDay(lessonsArray) {
            if (!Array.isArray(lessonsArray)) return;
            for (let i = 0; i < lessonsArray.length; i++) {
                const lesson = lessonsArray[i];
                if (lesson && lesson.–ø—Ä–µ–¥–º–µ—Ç) {
                    lesson.—É—Ä–æ–∫ = i + 1;
                }
            }
        }

        function displaySchedule() {
            const className = document.getElementById('classSelect').value;
            const table = document.getElementById('scheduleTable');

            if (!className || !appState.schedule) {
                table.innerHTML = '<div class="message info">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</div>';
                return;
            }

            const schedule = appState.schedule[className];
            if (!schedule) {
                table.innerHTML = '<div class="message error">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            const daysOrder = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];
            const days = daysOrder.filter(d => d in schedule);

            if (days.length === 0) {
                table.innerHTML = '<div class="message error">–ù–µ—Ç –¥–Ω–µ–π –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</div>';
                return;
            }

            let html = '<table><tr><th>–£—Ä–æ–∫</th>';
            days.forEach(day => html += '<th>' + day + '</th>');
            html += '</tr>';

            const maxLessons = 7;

            for (let i = 0; i < maxLessons; i++) {
                html += '<tr><td><strong>' + (i + 1) + '</strong></td>';

                days.forEach(day => {
                    const dayData = schedule[day];
                    let lessonsArray = [];

                    if (Array.isArray(dayData)) {
                        lessonsArray = dayData;
                    } else if (typeof dayData === 'object' && dayData !== null) {
                        lessonsArray = Object.values(dayData);
                    }

                    let lesson = lessonsArray.find(l => l && l.—É—Ä–æ–∫ === i + 1);
                    if (!lesson && lessonsArray[i] && lessonsArray[i].–ø—Ä–µ–¥–º–µ—Ç) {
                         lesson = lessonsArray[i];
                    }

                    html += `<td
                        data-day="${day}"
                        data-index="${i}"
                        class="lesson-cell"
                    >`;

                    if (lesson && lesson.–ø—Ä–µ–¥–º–µ—Ç) {
                        html += `<div class="lesson-card"
                            draggable="true"
                            data-day="${day}"
                            data-index="${i}"
                            data-teacher="${lesson.—É—á–∏—Ç–µ–ª—å || ''}"
                            data-room="${lesson.–∫–∞–±–∏–Ω–µ—Ç || ''}">
                            <strong>${lesson.–ø—Ä–µ–¥–º–µ—Ç}</strong><br>
                            <small>${lesson.—É—á–∏—Ç–µ–ª—å || 'N/A'}</small><br>
                            <small style="color: #666;">–ö–∞–±. ${lesson.–∫–∞–±–∏–Ω–µ—Ç || '?'}</small>
                            <div class="conflict-tooltip"></div>
                        </div>`;
                    }

                    html += '</td>';
                });

                html += '</tr>';
            }

            html += '</table>';
            table.innerHTML = html;

            attachDragDropHandlers();
            setTimeout(validateConflicts, 100);
        }

        //–£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–õ–ò–ö–¢–û–í –° –¢–ï–ö–°–¢–û–ú –ò –¢–ò–ü–ê–ú–ò
        function validateConflicts() {
            document.querySelectorAll('.lesson-card').forEach(c => {
                c.classList.remove('conflict-teacher', 'conflict-room');
                const t = c.querySelector('.conflict-tooltip');
                if(t) {
                    t.style.display = 'none';
                    t.textContent = '';
                }
            });

            const currentClass = document.getElementById('classSelect').value;
            const allCards = document.querySelectorAll('.lesson-card');

            const teacherOccupied = {};
            const roomOccupied = {}; // –î–ª—è –∂–µ–ª—Ç—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            const daysOrder = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];

            if (appState.schedule) {
                 for (const [clsName, clsSched] of Object.entries(appState.schedule)) {
                     if (clsName === currentClass) continue;

                     for (const day of daysOrder) {
                         const lessons = clsSched[day] || [];
                         const lessonsArr = Array.isArray(lessons) ? lessons : Object.values(lessons);

                         lessonsArr.forEach((l) => {
                             if (l && (l.—É—á–∏—Ç–µ–ª—å || l.–∫–∞–±–∏–Ω–µ—Ç)) {
                                 const lessonNum = l.—É—Ä–æ–∫ ? (parseInt(l.—É—Ä–æ–∫) - 1) : -1;
                                 if (lessonNum >= 0) {
                                     const key = `${day}_${lessonNum}`;

                                     // –£—á–∏—Ç–µ–ª—è
                                     if(l.—É—á–∏—Ç–µ–ª—å) {
                                         if (!teacherOccupied[key]) teacherOccupied[key] = {};
                                         teacherOccupied[key][l.—É—á–∏—Ç–µ–ª—å] = clsName;
                                     }

                                     // –ö–∞–±–∏–Ω–µ—Ç—ã
                                     if(l.–∫–∞–±–∏–Ω–µ—Ç) {
                                         if (!roomOccupied[key]) roomOccupied[key] = {};
                                         roomOccupied[key][l.–∫–∞–±–∏–Ω–µ—Ç] = clsName;
                                     }
                                 }
                             }
                         });
                     }
                 }
            }

            allCards.forEach(card => {
                const day = card.getAttribute('data-day');
                const index = card.getAttribute('data-index');
                const teacher = card.getAttribute('data-teacher');
                const room = card.getAttribute('data-room');
                const key = `${day}_${index}`;
                let tooltipText = [];

                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∏—Ç–µ–ª–µ–π (–ö–†–ê–°–ù–´–ô)
                if (teacher && teacherOccupied[key] && teacherOccupied[key][teacher]) {
                    card.classList.add('conflict-teacher');
                    tooltipText.push(`‚ùå –í –∫–ª–∞—Å—Å–µ ${teacherOccupied[key][teacher]}`);
                }

                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (–û–†–ê–ù–ñ–ï–í–´–ô)
                if (room && roomOccupied[key] && roomOccupied[key][room]) {
                    card.classList.add('conflict-room');
                    tooltipText.push(`‚ö†Ô∏è –ö–∞–±. –≤ –∫–ª–∞—Å—Å–µ ${roomOccupied[key][room]}`);
                }

                if (tooltipText.length > 0) {
                    const tooltip = card.querySelector('.conflict-tooltip');
                    if (tooltip) {
                        tooltip.textContent = tooltipText.join('; ');
                    }
                }
            });
        }


        function attachDragDropHandlers() {
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            document.querySelectorAll('.lesson-cell').forEach(cell => {
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('dragenter', handleDragEnter);
                cell.addEventListener('dragleave', handleDragLeave);
                cell.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            const card = e.target.closest('.lesson-card');
            const day = card.getAttribute('data-day');
            const index = parseInt(card.getAttribute('data-index'));

            dragState.sourceDay = day;
            dragState.sourceIndex = index;

            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({ day, index }));
        }

        function handleDragEnd(e) {
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            validateConflicts();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            const cell = e.target.closest('.lesson-cell');
            if (cell) cell.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            const cell = e.target.closest('.lesson-cell');
            if (cell && e.target === cell) cell.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const targetCell = e.target.closest('.lesson-cell');
            if (!targetCell) return;

            const targetDay = targetCell.getAttribute('data-day');
            const targetIndex = parseInt(targetCell.getAttribute('data-index'));

            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));

            if (!dragState.sourceDay || dragState.sourceIndex === null) {
                dragState = { sourceDay: null, sourceIndex: null, sourceLesson: null };
                return;
            }

            if (dragState.sourceDay === targetDay && dragState.sourceIndex === targetIndex) {
                dragState = { sourceDay: null, sourceIndex: null, sourceLesson: null };
                return;
            }

            const className = document.getElementById('classSelect').value;
            const schedule = appState.schedule[className];

            let sourceArray = schedule[dragState.sourceDay];
            let targetArray = schedule[targetDay];

            if (!Array.isArray(sourceArray)) {
                 sourceArray = schedule[dragState.sourceDay] = Object.values(sourceArray || {});
            }
            if (!Array.isArray(targetArray)) {
                 targetArray = schedule[targetDay] = Object.values(targetArray || {});
            }

            const sourceIdx = dragState.sourceIndex;
            const targetIdx = targetIndex;

            const sourceLesson = sourceArray[sourceIdx] || null;
            const targetLesson = targetArray[targetIdx] || null;

            if (!sourceLesson) return;

            if (targetLesson) {
                targetArray[targetIdx] = sourceLesson;
                sourceArray[sourceIdx] = targetLesson;
            }
            else {
                targetArray[targetIdx] = sourceLesson;
                sourceArray[sourceIdx] = null;
            }

            renumberDay(sourceArray);
            if (sourceArray !== targetArray) {
                renumberDay(targetArray);
            }

            schedule[dragState.sourceDay] = sourceArray;
            schedule[targetDay] = targetArray;
            appState.schedule[className] = schedule;

            dragState = { sourceDay: null, sourceIndex: null, sourceLesson: null };

            displaySchedule();
        }

        // –≠–ö–°–ü–û–†–¢

        function exportExcel() {
            fetch('http://localhost:5000/api/export/xlsx')
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ_' + new Date().toISOString().slice(0,10) + '.xlsx';
                    a.click();
                    document.getElementById('exportMessage').innerHTML =
                        '<div class="message success">‚úÖ XLSX —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!</div>';
                })
                .catch(error => {
                    document.getElementById('exportMessage').innerHTML =
                        '<div class="message error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
                });
        }

        function exportPDF() {
            fetch('http://localhost:5000/api/export/pdf')
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ_' + new Date().toISOString().slice(0,10) + '.pdf';
                    a.click();
                    document.getElementById('exportMessage').innerHTML =
                        '<div class="message success">‚úÖ PDF —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!</div>';
                })
                .catch(error => {
                    document.getElementById('exportMessage').innerHTML =
                        '<div class="message error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
                });
        }

        function exportJSON() {
            fetch('http://localhost:5000/api/export/json')
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ_' + new Date().toISOString().slice(0,10) + '.json';
                    a.click();
                    document.getElementById('exportMessage').innerHTML =
                        '<div class="message success">‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!</div>';
                })
                .catch(error => {
                    document.getElementById('exportMessage').innerHTML =
                        '<div class="message error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
                });
        }

        function copyToClipboard() {
            if (!appState.schedule) {
                document.getElementById('exportMessage').innerHTML =
                    '<div class="message error">‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>';
                return;
            }

            const json = JSON.stringify(appState.schedule, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                document.getElementById('exportMessage').innerHTML =
                    '<div class="message success">‚úÖ JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</div>';
            }).catch(err => {
                document.getElementById('exportMessage').innerHTML =
                    '<div class="message error">‚ùå –û—à–∏–±–∫–∞: ' + err + '</div>';
            });
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();

            const classes = [
                ['–∫–ª–∞—Å—Å', '–ø–∞—Ä–∞–ª–ª–µ–ª—å', '–∫–æ–ª_–≤–æ_—É—á–µ–Ω–∏–∫–æ–≤', '–∫–∞–±–∏–Ω–µ—Ç_–æ—Å–Ω–æ–≤–Ω–æ–π'],
                ['1–ê', '1', '28', '101'],
                ['1–ë', '1', '32', '102']
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(classes);
            XLSX.utils.book_append_sheet(wb, ws1, '–ü–∞—Ä–∞–ª–ª–µ–ª–∏');

            const subjects = [
                ['–ø—Ä–µ–¥–º–µ—Ç', '–ø–∞—Ä–∞–ª–ª–µ–ª—å', '—á–∞—Å–æ–≤_–≤_–Ω–µ–¥–µ–ª—é', '—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è', '—É—á–∏—Ç–µ–ª—å'],
                ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '1', '4', '–ø–∞—Ä–Ω—ã–µ_–ø–æ–¥—Ä—è–¥', '–ò–≤–∞–Ω–æ–≤–∞ –ò.–ò.'],
                ['–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '1', '4', '–ª—é–±–æ–π_—Ñ–æ—Ä–º–∞—Ç', '–ü–µ—Ç—Ä–æ–≤–∞ –ü.–ü.']
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(subjects);
            XLSX.utils.book_append_sheet(wb, ws2, '–ü—Ä–µ–¥–º–µ—Ç—ã');

            const teachers = [
                ['–§–ò–û', '–ø—Ä–µ–¥–º–µ—Ç—ã', '–º–∞–∫—Å_—É—Ä–æ–∫–æ–≤_–≤_–¥–µ–Ω—å', '–æ–∫–Ω–∞', '–∫–∞–±–∏–Ω–µ—Ç—ã'],
                ['–ò–≤–∞–Ω–æ–≤–∞ –ò.–ò.', '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '5', '–Ω–æ—Ä–º–∞', '101;102']
            ];
            const ws3 = XLSX.utils.aoa_to_sheet(teachers);
            XLSX.utils.book_append_sheet(wb, ws3, '–£—á–∏—Ç–µ–ª—è');

            const rooms = [
                ['–∫–∞–±–∏–Ω–µ—Ç', '–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å', '—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', '–¥–æ—Å—Ç—É–ø–µ–Ω'],
                ['101', '34', '–æ–±—â–∏–π', '–ü–Ω-–ü—Ç']
            ];
            const ws4 = XLSX.utils.aoa_to_sheet(rooms);
            XLSX.utils.book_append_sheet(wb, ws4, '–ö–∞–±–∏–Ω–µ—Ç—ã');

            XLSX.writeFile(wb, 'template_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        // –ê–ù–ê–õ–ò–¢–ò–ö–ê
        
        function updateAnalytics() {
            const msg = document.getElementById('analyticsMessage');
            msg.innerHTML = '';

            if (!appState.schedule) {
                msg.innerHTML = '<div class="message error">‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>';
                return;
            }

            const daysOrder = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];
            const allClasses = Object.keys(appState.schedule);

            // 1. –ü–û–î–°–ß–ï–¢ –û–ö–û–ù –£–ß–ò–¢–ï–õ–ï–ô 
            const teacherSchedules = {};
            const teacherWindows = {};

            allClasses.forEach(cls => {
                const sched = appState.schedule[cls];
                daysOrder.forEach(day => {
                    const lessons = Array.isArray(sched[day]) ? sched[day] : (sched[day] ? Object.values(sched[day]) : []);
                    lessons.forEach(l => {
                        if (l && l.—É—á–∏—Ç–µ–ª—å && l.—É—Ä–æ–∫) {
                            if (!teacherSchedules[l.—É—á–∏—Ç–µ–ª—å]) teacherSchedules[l.—É—á–∏—Ç–µ–ª—å] = {};
                            if (!teacherSchedules[l.—É—á–∏—Ç–µ–ª—å][day]) teacherSchedules[l.—É—á–∏—Ç–µ–ª—å][day] = [];
                            teacherSchedules[l.—É—á–∏—Ç–µ–ª—å][day].push(parseInt(l.—É—Ä–æ–∫));
                        }
                    });
                });
            });

            let totalWindows = 0;
            const windowsByTeacher = [];

            Object.entries(teacherSchedules).forEach(([teacher, days]) => {
                let wCount = 0;
                Object.values(days).forEach(lessonIndices => {
                    lessonIndices.sort((a,b) => a-b);
                    if (lessonIndices.length > 1) {
                        for (let i = 0; i < lessonIndices.length - 1; i++) {
                            if (lessonIndices[i+1] - lessonIndices[i] > 1) {
                                wCount += (lessonIndices[i+1] - lessonIndices[i] - 1);
                            }
                        }
                    }
                });
                if (wCount > 0) {
                    windowsByTeacher.push({name: teacher, count: wCount});
                    totalWindows += wCount;
                }
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —É—á–∏—Ç–µ–ª–µ–π –ø–æ –æ–∫–Ω–∞–º
            windowsByTeacher.sort((a, b) => b.count - a.count);

            // 2. –ó–ê–ì–†–£–ó–ö–ê –ö–ê–ë–ò–ù–ï–¢–û–í
            const roomUsage = {};
            allClasses.forEach(cls => {
                const sched = appState.schedule[cls];
                daysOrder.forEach(day => {
                    const lessons = Array.isArray(sched[day]) ? sched[day] : (sched[day] ? Object.values(sched[day]) : []);
                    lessons.forEach(l => {
                        if (l && l.–∫–∞–±–∏–Ω–µ—Ç) {
                            roomUsage[l.–∫–∞–±–∏–Ω–µ—Ç] = (roomUsage[l.–∫–∞–±–∏–Ω–µ—Ç] || 0) + 1;
                        }
                    });
                });
            });

            const sortedRooms = Object.entries(roomUsage)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 7); // –¢–æ–ø 7

            // 3. –ö–û–ù–§–õ–ò–ö–¢–´ (–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ appState.optimizationResults –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º)
            let conflictTeachers = 0;
            let conflictRooms = 0;

            if (appState.optimizationResults && appState.optimizationResults.conflicts) {
                conflictTeachers = appState.optimizationResults.conflicts.teacher_conflicts || 0;
                conflictRooms = appState.optimizationResults.conflicts.room_conflicts || 0;
            }

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–í–û–î–ù–´–• –ö–ê–†–¢–û–ß–ï–ö
            document.getElementById('statTeacherConflicts').textContent = conflictTeachers;
            document.getElementById('statRoomConflicts').textContent = conflictRooms;
            document.getElementById('statTeacherWindows').textContent = totalWindows;

             // Fitness
            if (appState.optimizationResults && typeof appState.optimizationResults.fitness !== 'undefined') {
                document.getElementById('statFitness').textContent = Math.round(appState.optimizationResults.fitness) + '%';
            } else {
                document.getElementById('statFitness').textContent = document.getElementById('fitnessScore')?.textContent || '0%';
            }

            // –°–ü–ò–°–û–ö "–û–ö–û–ù"
            const windowsListEl = document.getElementById('teachersWindowsList');
            windowsListEl.innerHTML = '';
            if (windowsByTeacher.length === 0) {
                 windowsListEl.innerHTML = '<li style="padding: 8px; color: green;">üéâ –£—Ä–∞! –ù–∏ —É –∫–æ–≥–æ –Ω–µ—Ç –æ–∫–æ–Ω!</li>';
            } else {
                windowsByTeacher.slice(0, 5).forEach(item => {
                    const li = document.createElement('li');
                    li.style.cssText = 'padding: 8px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between;';
                    li.innerHTML = `<span>${item.name}</span> <span style="font-weight:bold; color:#e74c3c">${item.count} –æ–∫–æ–Ω</span>`;
                    windowsListEl.appendChild(li);
                });
            }

            // –ì–†–ê–§–ò–ö–ò
            const roomCtx = document.getElementById('roomLoadChart').getContext('2d');
            const teacherDistCtx = document.getElementById('teacherDistributionChart').getContext('2d');

            if (roomLoadChart) roomLoadChart.destroy();
            if (teacherDistributionChart) teacherDistributionChart.destroy();

            // 1. –ì—Ä–∞—Ñ–∏–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –±–∞—Ä)
            roomLoadChart = new Chart(roomCtx, {
                type: 'bar',
                data: {
                    labels: sortedRooms.map(r => '–ö–∞–±. ' + r[0]),
                    datasets: [{
                        label: '–£—Ä–æ–∫–æ–≤ –≤ –Ω–µ–¥–µ–ª—é',
                        data: sortedRooms.map(r => r[1]),
                        backgroundColor: '#3498db',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // 2. –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—á–∏—Ç–µ–ª–µ–π (Pie Chart: –ù–æ—Ä–º–∞ / –ü–µ—Ä–µ–≥—Ä—É–∑ / –ù–µ–¥–æ–≥—Ä—É–∑)
            // –£—Å–ª–æ–≤–Ω–æ: –ù–æ—Ä–º–∞ 18-24 —á–∞—Å–∞, –ù–µ–¥–æ–≥—Ä—É–∑ <18, –ü–µ—Ä–µ–≥—Ä—É–∑ >24 (–ø—Ä–∏–º–µ—Ä–Ω–æ)
            let normalLoad = 0;
            let heavyLoad = 0;
            let lightLoad = 0;

            Object.values(teacherSchedules).forEach(days => {
                let lessonsCount = 0;
                Object.values(days).forEach(l => lessonsCount += l.length);
                if (lessonsCount < 18) lightLoad++;
                else if (lessonsCount > 26) heavyLoad++;
                else normalLoad++;
            });

            teacherDistributionChart = new Chart(teacherDistCtx, {
                type: 'doughnut',
                data: {
                    labels: ['–ù–æ—Ä–º–∞ (18-26)', '–ù–µ–¥–æ–≥—Ä—É–∑ (<18)', '–ü–µ—Ä–µ–≥—Ä—É–∑ (>26)'],
                    datasets: [{
                        data: [normalLoad, lightLoad, heavyLoad],
                        backgroundColor: ['#27ae60', '#f1c40f', '#e74c3c'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            msg.innerHTML = '<div class="message success">‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã</div>';
        }
    </script>
</body>
</html>
